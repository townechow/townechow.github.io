1:"$Sreact.fragment"
2:I[5244,[],""]
3:I[3866,[],""]
5:I[6213,[],"OutletBoundary"]
7:I[6213,[],"MetadataBoundary"]
9:I[6213,[],"ViewportBoundary"]
b:I[4835,[],""]
:HL["/_next/static/media/569ce4b8f30dc480-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/media/93f479601ee12b01-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/css/d498c84e4ab246b3.css","style"]
:HL["/_next/static/css/485ff6fe79292a08.css","style"]
:HL["/_next/static/css/b9d97b2190475167.css","style"]
:HL["/_next/static/css/851cdee6d90716dd.css","style"]
0:{"P":null,"b":"NFjmtHF2up8B2PpbDjLiS","p":"","c":["","front-end","computer-networks","web-security","csrf"],"i":false,"f":[[["",{"children":["front-end",{"children":[["slug","computer-networks/web-security/csrf","oc"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/d498c84e4ab246b3.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/485ff6fe79292a08.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","2",{"rel":"stylesheet","href":"/_next/static/css/b9d97b2190475167.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","children":["$","body",null,{"className":"__variable_4d318d __variable_ea5f4b antialiased","children":["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[],[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]}]]}],{"children":["front-end",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/851cdee6d90716dd.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","main",null,{"children":["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","front-end","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]}]]}],{"children":[["slug","computer-networks/web-security/csrf","oc"],["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","front-end","children","$0:f:0:1:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L4",null,["$","$L5",null,{"children":"$L6"}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","N5NZoyccXDoSYPnRaBVBX",{"children":[["$","$L7",null,{"children":"$L8"}],["$","$L9",null,{"children":"$La"}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}]]}],false]],"m":"$undefined","G":["$b","$undefined"],"s":false,"S":true}
c:T5d5b,<h1>CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»</h1>
<p><strong>è·¨ç«™è¯·æ±‚ä¼ªé€ </strong>ï¼ˆCross-site Request Forgeryï¼Œç®€ç§° CSRFï¼‰æ˜¯ä¸€ç§æŒŸåˆ¶ç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„ Web é¡µé¢ä¸Šæ‰§è¡Œéæœ¬æ„çš„æ“ä½œçš„æ”»å‡»æ–¹æ³•ã€‚</p>
<p>CSRF æ”»å‡»çš„æœ¬è´¨æ˜¯åˆ©ç”¨ cookie ä¼šåœ¨åŒæºè¯·æ±‚ä¸­æºå¸¦å‘é€ç»™æœåŠ¡å™¨çš„ç‰¹ç‚¹ï¼Œä»¥æ­¤æ¥å®ç°ç”¨æˆ·çš„å†’å……ã€‚</p>
<p>ä¸ <a href="/front-end/computer-networks/web-security/xss">XSS</a> ç›¸æ¯”ï¼ŒXSS åˆ©ç”¨çš„æ˜¯ç”¨æˆ·å¯¹æŒ‡å®šç½‘ç«™çš„ä¿¡ä»»ï¼ŒCSRF åˆ©ç”¨çš„æ˜¯ç½‘ç«™å¯¹ç”¨æˆ·ç½‘é¡µæµè§ˆå™¨çš„ä¿¡ä»»ã€‚</p>
<h2>æ”»å‡»æ‰‹æ®µ</h2>
<p>CSRF æ¼æ´å³åˆ©ç”¨ç½‘ç«™æƒé™æ ¡éªŒæ¼æ´åœ¨ç”¨æˆ·ä¸çŸ¥è§‰æƒ…å†µä¸‹å‘é€è¯·æ±‚ï¼Œè¾¾åˆ° <strong>ä¼ªè£…</strong> ç”¨æˆ·çš„ç›®çš„ã€‚</p>
<p>å…¸å‹çš„ CSRF æ”»å‡»æœ‰ç€å¦‚ä¸‹çš„æµç¨‹ï¼š</p>
<ol>
<li>å—å®³è€…ç™»å½• <code>a.com</code>ï¼Œå¹¶ä¿ç•™äº†ç™»å½•å‡­è¯ Cookie</li>
<li>æ”»å‡»è€… &lt;strong style=&quot;color:red&quot;&gt;å¼•è¯±&lt;/strong&gt; å—å®³è€…è®¿é—®äº† <code>b.com</code></li>
<li><code>b.com</code> å‘ <code>a.com</code> å‘é€äº†ä¸€ä¸ªè¯·æ±‚ï¼š<code>a.com/act=xx</code>ï¼Œæµè§ˆå™¨ä¼šé»˜è®¤æºå¸¦ <code>a.com</code> çš„ Cookie</li>
<li><code>a.com</code> æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¯¹è¯·æ±‚è¿›è¡ŒéªŒè¯ï¼Œå¹¶ç¡®è®¤æ˜¯å—å®³è€…çš„å‡­è¯ï¼Œè¯¯ä»¥ä¸ºæ˜¯å—å®³è€…è‡ªå·±å‘é€çš„è¯·æ±‚</li>
<li><code>a.com</code> ä»¥å—å®³è€…çš„åä¹‰æ‰§è¡Œäº† <code>act=xxx</code></li>
<li>æ”»å‡»å®Œæˆï¼Œæ”»å‡»è€…åœ¨å—å®³è€…ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ï¼Œå†’å……å—å®³è€…ï¼Œè®© <code>a.com</code> æ‰§è¡Œäº†è‡ªå·±å®šä¹‰çš„æ“ä½œ</li>
</ol>
<p>æ”»å‡»è€…åˆ©ç”¨ CSRF å®ç°çš„æ”»å‡»ä¸»è¦æ–¹å¼ï¼š</p>
<ul>
<li>æ”»å‡»è€…èƒ½å¤Ÿæ¬ºéª—å—å®³ç”¨æˆ·å®Œæˆè¯¥å—å®³è€…æ‰€å…è®¸çš„ä»»ä¸€çŠ¶æ€æ”¹å˜çš„æ“ä½œ
<ul>
<li>å¦‚ï¼šæ›´æ–°è´¦å·ä¿¡æ¯ã€å®Œæˆè´­ç‰©ã€æ³¨é”€ç”šè‡³ç™»é™†ç­‰æ“ä½œ</li>
</ul>
</li>
<li>è·å–ç”¨æˆ·çš„éšç§æ•°æ®</li>
<li>CSRF è •è™«</li>
<li>é…åˆå…¶ä»–æ¼æ´æ”»å‡»</li>
</ul>
<h3>GET ç±»å‹</h3>
<p>åœ¨å—å®³è€…è®¿é—®å«æœ‰è¿™ä¸ª <code>img</code> çš„é¡µé¢åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å‘ <code>http://bank.example/transfer?account=xiaoming&amp;amount=10000&amp;for=hacker</code> å‘å‡ºä¸€æ¬¡ HTTP è¯·æ±‚ã€‚<code>bank.example</code> å°±ä¼šæ”¶åˆ°åŒ…å«å—å®³è€…ç™»å½•ä¿¡æ¯çš„ä¸€æ¬¡è·¨åŸŸè¯·æ±‚ã€‚</p>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://bank.example/transfer?amount=10000&amp;for=hacker&quot;</span> /&gt;</span>
</code></pre>
<h3>POST ç±»å‹</h3>
<p>è¿™ç§ç±»å‹çš„ CSRF åˆ©ç”¨èµ·æ¥é€šå¸¸ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªè‡ªåŠ¨æäº¤çš„è¡¨å•ï¼Œå¦‚ï¼š</p>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://bank.example/transfer&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;account&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;xiaoming&quot;</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;amount&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;for&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;hacker&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">forms</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">submit</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>è®¿é—®è¯¥é¡µé¢åï¼Œè¡¨å•ä¼šè‡ªåŠ¨æäº¤ï¼Œç›¸å½“äºæ¨¡æ‹Ÿç”¨æˆ·å®Œæˆäº†ä¸€æ¬¡ POST æ“ä½œã€‚</p>
<p>POST ç±»å‹çš„æ”»å‡»é€šå¸¸æ¯” GET è¦æ±‚æ›´åŠ ä¸¥æ ¼ä¸€ç‚¹ï¼Œä½†ä»å¹¶ä¸å¤æ‚ã€‚ä»»ä½•ä¸ªäººç½‘ç«™ã€åšå®¢ï¼Œè¢«é»‘å®¢ä¸Šä¼ é¡µé¢çš„ç½‘ç«™éƒ½æœ‰å¯èƒ½æ˜¯å‘èµ·æ”»å‡»çš„æ¥æºï¼Œåç«¯æ¥å£ä¸èƒ½å°†å®‰å…¨å¯„æ‰˜åœ¨ä»…å…è®¸ POST ä¸Šé¢ã€‚</p>
<h3>é“¾æ¥ç±»å‹</h3>
<p>é“¾æ¥ç±»å‹çš„ CSRF å¹¶ä¸å¸¸è§ï¼Œæ¯”èµ·å…¶ä»–ä¸¤ç§ç”¨æˆ·æ‰“å¼€é¡µé¢å°±ä¸­æ‹›çš„æƒ…å†µï¼Œè¿™ç§ &lt;strong style=&quot;color:red&quot;&gt;éœ€è¦ç”¨æˆ·ç‚¹å‡»é“¾æ¥&lt;/strong&gt; æ‰ä¼šè§¦å‘ã€‚è¿™ç§ç±»å‹é€šå¸¸æ˜¯åœ¨è®ºå›ä¸­å‘å¸ƒçš„å›¾ç‰‡ä¸­åµŒå…¥æ¶æ„é“¾æ¥ï¼Œæˆ–è€…ä»¥å¹¿å‘Šçš„å½¢å¼è¯±å¯¼ç”¨æˆ·ä¸­æ‹›ï¼Œæ”»å‡»è€…é€šå¸¸ä¼šä»¥æ¯”è¾ƒå¤¸å¼ çš„è¯è¯­è¯±éª—ç”¨æˆ·ç‚¹å‡»ï¼Œä¾‹å¦‚ï¼š</p>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://test.com/csrf/transfer.php?amount=1000&amp;for=hacker&quot;</span> <span class="hljs-attr">taget</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>é‡ç£…æ¶ˆæ¯ï¼ï¼<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>ç”±äºä¹‹å‰ç”¨æˆ·ç™»å½•äº†ä¿¡ä»»çš„ç½‘ç«™ï¼Œå¹¶ä¸”ä¿å­˜ç™»å½•çŠ¶æ€ï¼Œåªè¦ç”¨æˆ·ä¸»åŠ¨è®¿é—®ä¸Šé¢çš„è¿™ä¸ª PHP é¡µé¢ï¼Œåˆ™è¡¨ç¤ºæ”»å‡»æˆåŠŸã€‚</p>
<h2>æ”»å‡»ç‰¹ç‚¹</h2>
<ul>
<li>æ”»å‡» <strong>ä¸€èˆ¬å‘èµ·åœ¨ç¬¬ä¸‰æ–¹ç½‘ç«™</strong>ï¼Œè€Œä¸æ˜¯è¢«æ”»å‡»çš„ç½‘ç«™ï¼Œè¢«æ”»å‡»çš„ç½‘ç«™æ— æ³•é˜²æ­¢æ”»å‡»å‘ç”Ÿ</li>
<li>æ”»å‡» <strong>åˆ©ç”¨å—å®³è€…è¢«æ”»å‡»ç½‘ç«™çš„ç™»å½•å‡­è¯</strong>ï¼Œå†’å……å—å®³è€…æäº¤æ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥çªƒå–æ•°æ®</li>
<li>æ•´ä¸ªè¿‡ç¨‹æ”»å‡»è€…å¹¶ä¸èƒ½è·å–åˆ°å—å®³è€…çš„ç™»å½•å‡­è¯ï¼Œä»…ä»…æ˜¯ &lt;strong style=&quot;color:red&quot;&gt;å†’ç”¨&lt;/strong&gt;</li>
<li>è·¨ç«™è¯·æ±‚å¯ä»¥ç”¨å„ç§æ–¹å¼ï¼šå›¾ç‰‡ URLã€è¶…é“¾æ¥ã€CORSã€Form è¡¨å•æäº¤ç­‰ç­‰ï¼Œéƒ¨åˆ†è¯·æ±‚æ–¹å¼å¯ä»¥ç›´æ¥åµŒå…¥åœ¨ç¬¬ä¸‰æ–¹è®ºå›ã€æ–‡ç« ä¸­ï¼Œéš¾ä»¥è¿›è¡Œè¿½è¸ª</li>
</ul>
<p>å¯¹äºæœåŠ¡å™¨è¿”å›çš„ç»“æœï¼Œç”±äºæµè§ˆå™¨ <strong>åŒæºç­–ç•¥</strong> çš„é™åˆ¶ï¼Œé»‘å®¢ä¹Ÿæ— æ³•è¿›è¡Œè§£æã€‚å› æ­¤ï¼Œé»‘å®¢æ— æ³•ä»è¿”å›çš„ç»“æœä¸­å¾—åˆ°ä»»ä½•ä¸œè¥¿ï¼Œä»–æ‰€èƒ½åšçš„å°±æ˜¯ç»™æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»¥æ‰§è¡Œè¯·æ±‚ä¸­æ‰€æè¿°çš„å‘½ä»¤ï¼Œåœ¨æœåŠ¡å™¨ç«¯ç›´æ¥æ”¹å˜æ•°æ®çš„å€¼ï¼Œè€Œéçªƒå–æœåŠ¡å™¨ä¸­çš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦ä¿æŠ¤çš„å¯¹è±¡æ˜¯é‚£äº›å¯ä»¥ç›´æ¥äº§ç”Ÿæ•°æ®æ”¹å˜çš„æœåŠ¡ï¼Œè€Œå¯¹äºè¯»å–æ•°æ®çš„æœåŠ¡ï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œ CSRF çš„ä¿æŠ¤ã€‚æ¯”å¦‚é“¶è¡Œç³»ç»Ÿä¸­è½¬è´¦çš„è¯·æ±‚ä¼šç›´æ¥æ”¹å˜è´¦æˆ·çš„é‡‘é¢ï¼Œä¼šé­åˆ° CSRF æ”»å‡»ï¼Œéœ€è¦ä¿æŠ¤ã€‚è€ŒæŸ¥è¯¢é‡‘é¢æ˜¯å¯¹é‡‘é¢çš„è¯»å–æ“ä½œï¼Œä¸ä¼šæ”¹å˜æ•°æ®ï¼ŒCSRF æ”»å‡»æ— æ³•è§£ææœåŠ¡å™¨è¿”å›çš„ç»“æœï¼Œæ— éœ€ä¿æŠ¤ã€‚</p>
<h2>é˜²å¾¡ç­–ç•¥</h2>
<p>CSRF é€šå¸¸ä»ç¬¬ä¸‰æ–¹ç½‘ç«™å‘èµ·ï¼Œè¢«æ”»å‡»ç½‘ç«™æ— æ³•é˜²æ­¢æ”»å‡»å‘ç”Ÿï¼Œåªèƒ½é€šè¿‡å¢å¼ºè‡ªå·±ç½‘ç«™é’ˆå¯¹ CSRF çš„é˜²æŠ¤èƒ½åŠ›æ¥æå‡å®‰å…¨æ€§ã€‚</p>
<p>ä¸Šæ–‡ä¸­è®²äº† CSRF çš„ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>CSRFï¼ˆé€šå¸¸ï¼‰å‘ç”Ÿåœ¨ç¬¬ä¸‰æ–¹åŸŸå</li>
<li>CSRF æ”»å‡»è€…ä¸èƒ½è·å–åˆ° Cookie ç­‰ä¿¡æ¯ï¼Œåªèƒ½å†’ç”¨</li>
</ul>
<h3>é˜²å¾¡æ€è·¯</h3>
<p>é˜²å¾¡æ€è·¯ï¼š</p>
<ol>
<li>æˆ‘ä»¬èƒ½ä¸èƒ½ &lt;strong style=&quot;color:red&quot;&gt;åŒºåˆ†&lt;/strong&gt; ä¸€ä¸ªè¯·æ±‚æ˜¯æ¥è‡ªäºè‡ªå·±çš„å‰ç«¯é¡µé¢ï¼Œè¿˜æ˜¯ç¬¬ä¸‰æ–¹çš„ç½‘ç«™ï¼Ÿ</li>
<li>æ€ä¹ˆè®©è‡ªå·±çš„å‰ç«¯é¡µé¢å’Œä¼ªé€ çš„è¯·æ±‚å˜å¾— &lt;strong style=&quot;color:red&quot;&gt;ä¸ä¸€æ ·&lt;/strong&gt; å‘¢ï¼Ÿ</li>
</ol>
<p>é’ˆå¯¹ CSRF çš„ç‰¹ç‚¹åˆ¶å®šé˜²æŠ¤ç­–ç•¥ï¼š</p>
<ul>
<li>é˜»æ­¢ä¸æ˜å¤–åŸŸè®¿é—®
<ul>
<li>åŒæºæ£€æµ‹æœºåˆ¶ï¼šæœåŠ¡å™¨é€šè¿‡è¯·æ±‚å¤´é™„å¸¦çš„ <code>Origin</code> å’Œ <code>Referer</code> å­—æ®µç¡®å®šè¯·æ±‚çš„æ¥æºåŸŸ</li>
<li>Samesite Cookie</li>
</ul>
</li>
<li>æäº¤æ—¶è¦æ±‚é™„åŠ æœ¬åŸŸæ‰èƒ½è·å–çš„ä¿¡æ¯
<ul>
<li>CSRF Token</li>
<li>åŒé‡ Cookie éªŒè¯</li>
</ul>
</li>
<li>ä¿è¯ç½‘ç»œè¯·æ±‚ç”±çœŸå®ç”¨æˆ·å‘å‡º
<ul>
<li>ç”¨æˆ·æ“ä½œé™åˆ¶ï¼ˆéªŒè¯ç ï¼‰</li>
</ul>
</li>
</ul>
<h3>åŒæºæ£€æµ‹æœºåˆ¶</h3>
<p>æ—¢ç„¶ CSRF å¤§å¤šæ¥è‡ªç¬¬ä¸‰æ–¹ç½‘ç«™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç›´æ¥ç¦æ­¢å¤–åŸŸï¼ˆæˆ–è€…ä¸å—ä¿¡ä»»çš„åŸŸåï¼‰å¯¹æˆ‘ä»¬å‘èµ·è¯·æ±‚ã€‚</p>
<p>åœ¨ HTTP åè®®ä¸­ï¼Œæ¯ä¸ªä¸€éƒ¨è¯·æ±‚éƒ½ä¼šæºå¸¦ä¸¤ä¸ª Headerï¼Œç”¨äºæ ‡è®°æ¥æºåŸŸåï¼š</p>
<ul>
<li>Origin Header</li>
<li>Referrer Header</li>
</ul>
<p>è¿™ä¸¤ä¸ª Header åœ¨æµè§ˆå™¨å‘èµ·è¯·æ±‚æ—¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¼šè‡ªåŠ¨å¸¦ä¸Šï¼Œå¹¶ä¸”ä¸èƒ½ç”±å‰ç«¯è‡ªå®šä¹‰å†…å®¹ã€‚æœåŠ¡å™¨å¯ä»¥é€šè¿‡è§£æè¿™ä¸¤ä¸ª Header ä¸­çš„åŸŸåï¼Œç¡®å®šè¯·æ±‚çš„æ¥æºåŸŸã€‚</p>
<h4>Origin</h4>
<p>ä½¿ç”¨ Origin Header ç¡®å®šæ¥æºåŸŸåã€‚</p>
<p>åœ¨éƒ¨åˆ†ä¸ CSRF æœ‰å…³çš„è¯·æ±‚ä¸­ï¼Œè¯·æ±‚çš„ Header ä¸­ä¼šæºå¸¦ Origin å­—æ®µã€‚å­—æ®µå†…åŒ…å«è¯·æ±‚çš„åŸŸåï¼Œä¸åŒ…å« <code>path</code> åŠ <code>query</code> éƒ¨åˆ†ã€‚</p>
<pre class="hljs language-http"  style=--lang:"http" ><code><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://foo.example
</code></pre>
<p>å¦‚æœ Origin å­˜åœ¨ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨ Origin ä¸­çš„å­—æ®µç¡®è®¤æ¥æºåŸŸåå°±å¯ä»¥ã€‚</p>
<p>ä½†æ˜¯ Origin åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹å¹¶ä¸å­˜åœ¨ï¼š</p>
<ul>
<li>IE11 åŒæºç­–ç•¥ï¼šIE11 ä¸ä¼šåœ¨è·¨ç«™ CORS è¯·æ±‚ä¸Šæ·»åŠ  Origin æ ‡å¤´ï¼ŒReferrer å¤´ä»ç„¶æ˜¯å”¯ä¸€çš„æ ‡è¯†ã€‚æœ€æ ¹æœ¬åŸå› æ˜¯å› ä¸º IE11 å¯¹åŒæºçš„å®šä¹‰å’Œå…¶ä»–æµè§ˆå™¨ä¸åŒï¼Œæœ‰ä¸¤ä¸ªä¸»è¦çš„åŒºåˆ«ï¼Œå¯ä»¥å‚è€ƒ <a href="https://link.juejin.im/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FSame-origin_policy%23IE_Exceptions" target="_blank" rel="noopener noreferrer nofollow">MDN Same-origin_policy#IE_Exceptions</a></li>
<li>302 é‡å®šå‘ï¼šåœ¨ 302 é‡å®šå‘ä¹‹å Origin ä¸åŒ…å«åœ¨é‡å®šå‘çš„è¯·æ±‚ä¸­ï¼Œå› ä¸º Origin å¯èƒ½ä¼šè¢«è®¤ä¸ºæ˜¯å…¶ä»–æ¥æºçš„æ•æ„Ÿä¿¡æ¯ã€‚å¯¹äº 302 é‡å®šå‘çš„æƒ…å†µæ¥è¯´éƒ½æ˜¯å®šå‘åœ¨æ–°çš„æœåŠ¡å™¨ä¸Šçš„ URLï¼Œå› æ­¤æµè§ˆå™¨ä¸æƒ³å°† Origin æ³„æ¼åˆ°æ–°çš„æœåŠ¡å™¨ä¸Šã€‚</li>
</ul>
<h4>Referrer</h4>
<p>æ ¹æ® HTTP åè®®ï¼Œåœ¨ HTTP å¤´ä¸­æœ‰ä¸€ä¸ªå­—æ®µå« <code>referrer</code>ï¼Œè®°å½•äº†è¯¥ HTTP è¯·æ±‚çš„æ¥æºåœ°å€ã€‚</p>
<ul>
<li>å¯¹äº Ajax è¯·æ±‚ï¼Œå›¾ç‰‡å’Œè„šæœ¬æ–‡ä»¶ç­‰èµ„æºè¯·æ±‚ï¼Œ<code>referrer</code> ä¸ºå‘èµ·è¯·æ±‚çš„é¡µé¢åœ°å€ã€‚</li>
<li>å¯¹äºé¡µé¢è·³è½¬ï¼Œ<code>referrer</code> ä¸ºæ‰“å¼€é¡µé¢å†å²è®°å½•çš„å‰ä¸€é¡µé¢åœ°å€ã€‚</li>
</ul>
<p>å› æ­¤æˆ‘ä»¬ä½¿ç”¨ Referrer ä¸­é“¾æ¥çš„ Origin éƒ¨åˆ†å¯ä»¥å¾—åˆ° <strong>è¯·æ±‚çš„æ¥æºåŸŸå</strong>ã€‚</p>
<p>è¿™ç§æ–¹æ³•å¹¶éä¸‡æ— ä¸€å¤±ï¼Œ<code>referrer</code> çš„å€¼æ˜¯ç”±æµè§ˆå™¨æä¾›çš„ï¼Œè™½ç„¶ HTTP åè®®ä¸Šæœ‰æ˜ç¡®çš„è¦æ±‚ï¼Œä½†æ˜¯æ¯ä¸ªæµè§ˆå™¨å¯¹äº <code>referrer</code> çš„å…·ä½“å®ç°å¯èƒ½æœ‰å·®åˆ«ï¼Œå¹¶ä¸èƒ½ä¿è¯æµè§ˆå™¨è‡ªèº«æ²¡æœ‰å®‰å…¨æ¼æ´ã€‚ä½¿ç”¨éªŒè¯ <code>referrer</code> å€¼çš„æ–¹æ³•ï¼Œå°±æ˜¯æŠŠå®‰å…¨æ€§éƒ½ä¾èµ–äºç¬¬ä¸‰æ–¹ï¼ˆå³æµè§ˆå™¨ï¼‰æ¥ä¿éšœï¼Œä»ç†è®ºä¸Šæ¥è®²ï¼Œè¿™æ ·å¹¶ä¸æ˜¯å¾ˆå®‰å…¨ã€‚åœ¨éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥éšè—ï¼Œç”šè‡³ä¿®æ”¹è‡ªå·±è¯·æ±‚çš„ <code>referrer</code>ã€‚</p>
<p>æ–°ç‰ˆ Referrer Policy è§„å®šäº†äº”ç§ Referrer ç­–ç•¥ï¼š</p>
<ul>
<li>No Referrerï¼š<code>no-referrer</code></li>
<li>No Referrer When Downgradeï¼š<code>no-referrer-when-downgrade</code></li>
<li>Origin Onlyï¼š<code>origin</code></li>
<li>Origin When Cross-orginï¼š<code>origin-when-crossorigin</code></li>
<li>Unsafe URLï¼š<code>unsafe-url</code></li>
</ul>
<p><strong>ä½¿ç”¨ Referer Policy çš„æ–¹å¼</strong></p>
<ol>
<li>CSP å“åº”å¤´ï¼Œé€šè¿‡ <code>referrer</code> æŒ‡ä»¤å’Œäº”ç§å¯é€‰çš„æŒ‡ä»¤å€¼ï¼Œæ¥æŒ‡å®š Referrer ç­–ç•¥</li>
</ol>
<pre class="hljs language-http"  style=--lang:"http" ><code><span class="hljs-attribute">Content-Security-Policy</span><span class="hljs-punctuation">: </span>referrer no-referrer | no-referrer-when-downgrade | origin | origin-when-cross-origin | unsafe-url;
</code></pre>
<ol start="2">
<li><code>&lt;meta&gt;</code> å…ƒæ•°æ®æ ‡ç­¾ä¹Ÿå¯ä»¥æŒ‡å®š Referrer ç­–ç•¥</li>
</ol>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-comment">&lt;!-- åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œä»…å‘é€æ–‡ä»¶çš„æºä½œä¸ºå¼•ç”¨åœ°å€ --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;referrer&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;origin&quot;</span> /&gt;</span>
</code></pre>
<ol start="3">
<li>å¤–é“¾æ ‡ç­¾ä¸­çš„ <code>referrer</code> å±æ€§</li>
</ol>
<p>æˆ–è€…ç”¨ <code>&lt;a&gt;</code>ã€<code>&lt;area&gt;</code>ã€<code>&lt;img&gt;</code>ã€<code>&lt;iframe&gt;</code>ã€<code>&lt;script&gt;</code> æˆ–è€… <code>&lt;link&gt;</code> æ ‡ç­¾å…ƒç´ ä¸Šçš„ <code>referrerpolicy</code> å±æ€§ä¸ºå…¶è®¾ç½®ç‹¬ç«‹çš„è¯·æ±‚ç­–ç•¥ã€‚</p>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://example.com&quot;</span> <span class="hljs-attr">referrerpolicy</span>=<span class="hljs-string">&quot;origin&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>å¦å¤–ä¹Ÿå¯ä»¥åœ¨ <code>&lt;a&gt;</code>ã€<code>&lt;area&gt;</code> æˆ–è€… <code>&lt;link&gt;</code> å…ƒç´ ä¸Šå°† <code>rel</code> å±æ€§è®¾ç½®ä¸º <code>noreferrer</code>ã€‚</p>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://example.com&quot;</span> <span class="hljs-attr">referrer</span>=<span class="hljs-string">&quot;no-referrer|origin|unsafe-url&quot;</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>è¿™ç§æ–¹å¼ä½œç”¨çš„åªæ˜¯è¿™ä¸€ä¸ªé“¾æ¥ã€‚å¹¶ä¸”ï¼Œ<code>&lt;a&gt;</code> æ ‡ç­¾å¯ç”¨çš„ Referrer ç­–ç•¥åªæœ‰ä¸‰ç§ï¼šä¸ä¼ ã€åªä¼  host å’Œéƒ½ä¼ ã€‚å¦å¤–ï¼Œè¿™æ ·é’ˆå¯¹å•ä¸ªé“¾æ¥è®¾ç½®çš„ç­–ç•¥ä¼˜å…ˆçº§æ¯” CSP å’Œ <code>&lt;meta&gt;</code> è¦é«˜ã€‚</p>
<blockquote>
<p>å½“ Origin å’Œ Referrer å¤´æ–‡ä»¶ä¸å­˜åœ¨æ—¶è¯¥æ€ä¹ˆåŠï¼Ÿå¦‚æœ Origin å’Œ Referrer éƒ½ä¸å­˜åœ¨ï¼Œå»ºè®®ç›´æ¥è¿›è¡Œé˜»æ­¢ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨éšæœº CSRF Token ä½œä¸ºç¬¬äºŒæ¬¡æ£€æŸ¥ã€‚</p>
</blockquote>
<h3>Cookie çš„ SameSite å±æ€§</h3>
<p>Cookie çš„ <code>SameSite</code> å±æ€§èƒ½ç”¨äºé™åˆ¶ç¬¬ä¸‰æ–¹ Cookieï¼Œä»è€Œå‡å°‘å®‰å…¨é£é™©ã€‚</p>
<pre class="hljs language-http"  style=--lang:"http" ><code><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">: </span>CookieName=CookieValue; SameSite=Lax;
</code></pre>
<p>å¯å–å€¼ï¼š</p>
<ul>
<li><code>Strict</code>ï¼šå®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹ Cookieï¼Œè·¨ç«™ç‚¹æ—¶ï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šå‘é€ Cookieã€‚æ¢è¨€ä¹‹ï¼Œåªæœ‰å½“å‰ç½‘é¡µçš„ URL ä¸è¯·æ±‚ç›®æ ‡ä¸€è‡´ï¼Œæ‰ä¼šå¸¦ä¸Š Cookie</li>
<li><code>Lax</code>ï¼šå¤§å¤šæ•°æƒ…å†µä¸å‘é€ç¬¬ä¸‰æ–¹ Cookieï¼Œä½†æ˜¯å¯¼èˆªåˆ°ç›®æ ‡ç½‘ç«™çš„ GET è¯·æ±‚é™¤å¤–ï¼ˆå¯¼èˆªåˆ°ç›®æ ‡ç½‘å€çš„ GET è¯·æ±‚ï¼šé“¾æ¥ã€é¢„åŠ è½½è¯·æ±‚å’Œ GET è¡¨å•ï¼‰</li>
<li><code>None</code></li>
</ul>
<h3>CSRF Token</h3>
<p>å‰é¢è®²åˆ° CSRF çš„å¦ä¸€ä¸ªç‰¹å¾æ˜¯ï¼Œæ”»å‡»è€…æ— æ³•ç›´æ¥çªƒå–åˆ°ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆCookieï¼ŒHeaderï¼Œç½‘ç«™å†…å®¹ç­‰ï¼‰ï¼Œä»…ä»…æ˜¯å†’ç”¨ Cookie ä¸­çš„ä¿¡æ¯ã€‚è€Œ CSRF æ”»å‡»ä¹‹æ‰€ä»¥èƒ½å¤ŸæˆåŠŸï¼Œæ˜¯å› ä¸ºæœåŠ¡å™¨è¯¯æŠŠæ”»å‡»è€…å‘é€çš„è¯·æ±‚å½“æˆäº†ç”¨æˆ·è‡ªå·±çš„è¯·æ±‚ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¦æ±‚æ‰€æœ‰çš„ç”¨æˆ·è¯·æ±‚éƒ½æºå¸¦ä¸€ä¸ª CSRF æ”»å‡»è€…æ— æ³•è·å–åˆ°çš„ Tokenã€‚æœåŠ¡å™¨é€šè¿‡æ ¡éªŒè¯·æ±‚æ˜¯å¦æºå¸¦æ­£ç¡®çš„ Tokenï¼Œæ¥æŠŠæ­£å¸¸çš„è¯·æ±‚å’Œæ”»å‡»çš„è¯·æ±‚åŒºåˆ†å¼€ï¼Œä¹Ÿå¯ä»¥é˜²èŒƒ CSRF çš„æ”»å‡»ã€‚</p>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·åå¯†ç ç™»é™†ï¼ŒæœåŠ¡ç«¯ä¸‹å‘ä¸€ä¸ª &lt;strong style=&quot;color:red&quot;&gt;éšæœºçš„&lt;/strong&gt; Token å­—æ®µï¼Œå¹¶ä¸”æœåŠ¡ç«¯æŠŠè¿™ä¸ªå­—æ®µä¿å­˜åœ¨ Session ä¸­</li>
<li>å®¢æˆ·ç«¯æŠŠè¿™ä¸ª Token ä¿å­˜èµ·æ¥ï¼Œæ”¾åˆ°éšè—å­—æ®µ</li>
<li>ç”¨æˆ·åœ¨ç™»å½•çŠ¶æ€ä¸‹ï¼Œåœ¨ä¹‹åè®¿é—®çš„æ—¶å€™ï¼Œéƒ½è¦æºå¸¦è¿™ä¸ª Token å­—æ®µ</li>
<li>æœåŠ¡ç«¯ä» Session ä¸­æ‹¿å‡º Token å€¼è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´ï¼Œè¯´æ˜è¯·æ±‚åˆæ³•</li>
<li>ç”¨æˆ·æ¨å‡ºï¼ŒSession é”€æ¯ï¼ŒToken å¤±æ•ˆ</li>
</ol>
<p><strong>å®ç°åŸç†</strong></p>
<p>CSRF Token çš„é˜²æŠ¤ç­–ç•¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å°† CSRF Token è¾“å‡ºåˆ°é¡µé¢ä¸­</li>
</ol>
<p>é¦–å…ˆï¼Œç”¨æˆ·æ‰“å¼€é¡µé¢çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éœ€è¦ç»™è¿™ä¸ªç”¨æˆ·ç”Ÿæˆä¸€ä¸ª Tokenï¼Œè¯¥ Token é€šè¿‡åŠ å¯†ç®—æ³•å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä¸€èˆ¬ Token éƒ½åŒ…æ‹¬éšæœºå­—ç¬¦ä¸²å’Œæ—¶é—´æˆ³çš„ç»„åˆï¼Œæ˜¾ç„¶åœ¨æäº¤æ—¶ Token ä¸èƒ½å†æ”¾åœ¨ Cookie ä¸­äº†ï¼Œå¦åˆ™åˆä¼šè¢«æ”»å‡»è€…å†’ç”¨ã€‚å› æ­¤ï¼Œä¸ºäº†å®‰å…¨èµ·è§ Token æœ€å¥½è¿˜æ˜¯å­˜åœ¨æœåŠ¡å™¨çš„ Session ä¸­ï¼Œä¹‹ååœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶ï¼Œä½¿ç”¨ JS éå†æ•´ä¸ª DOM æ ‘ï¼Œå¯¹äº DOM ä¸­æ‰€æœ‰çš„ <code>&lt;a&gt;</code> å’Œ <code>&lt;form&gt;</code> æ ‡ç­¾ååŠ å…¥ Tokenã€‚è¿™æ ·å¯ä»¥è§£å†³å¤§éƒ¨åˆ†çš„è¯·æ±‚ï¼Œä½†æ˜¯å¯¹äºåœ¨é¡µé¢åŠ è½½ä¹‹ååŠ¨æ€ç”Ÿæˆçš„ HTML ä»£ç ï¼Œè¿™ç§æ–¹æ³•å°±æ²¡æœ‰ä½œç”¨ï¼Œè¿˜éœ€è¦å¼€å‘è€…åœ¨ç¼–ç æ—¶æ‰‹åŠ¨æ·»åŠ  Token</p>
<ol start="2">
<li>é¡µé¢æäº¤çš„è¯·æ±‚æºå¸¦è¿™ä¸ª Token</li>
</ol>
<p>å¯¹äº GET è¯·æ±‚ï¼ŒToken å°†é™„åœ¨è¯·æ±‚åœ°å€ä¹‹åï¼Œè¿™æ · URL å°±å˜æˆ <code>http://url?csrftoken=tokenvalue</code>ã€‚ è€Œå¯¹äº POST è¯·æ±‚æ¥è¯´ï¼Œè¦åœ¨ <code>form</code> çš„æœ€ååŠ ä¸Šï¼š</p>
<pre class="hljs language-html"  style=--lang:"html" ><code><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;â€hiddenâ€&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;â€csrftokenâ€&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;â€tokenvalueâ€&quot;</span> /&gt;</span>
</code></pre>
<ol start="3">
<li>æœåŠ¡å™¨éªŒè¯ Token æ˜¯å¦æ­£ç¡®</li>
</ol>
<p>å½“ç”¨æˆ·ä»å®¢æˆ·ç«¯å¾—åˆ°äº† <code>token</code>ï¼Œå†æ¬¡æäº¤ç»™æœåŠ¡å™¨çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éœ€è¦åˆ¤æ–­ <code>token</code> çš„æœ‰æ•ˆæ€§ï¼ŒéªŒè¯è¿‡ç¨‹æ˜¯å…ˆè§£å¯† <code>token</code>ï¼Œå¯¹æ¯”åŠ å¯†å­—ç¬¦ä¸²ä»¥åŠæ—¶é—´æˆ³ï¼Œå¦‚æœåŠ å¯†å­—ç¬¦ä¸²ä¸€è‡´ä¸”æ—¶é—´æœªè¿‡æœŸï¼Œé‚£ä¹ˆè¿™ä¸ª Token å°±æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p>è¿™ç§æ–¹æ³•è¦æ¯”ä¹‹å‰æ£€æŸ¥ <code>referer</code> æˆ–è€… <code>origin</code> è¦å®‰å…¨ä¸€äº›ï¼Œ<code>token</code> å¯ä»¥åœ¨äº§ç”Ÿå¹¶æ”¾äº Session ä¹‹ä¸­ï¼Œç„¶ååœ¨æ¯æ¬¡è¯·æ±‚æ—¶æŠŠ <code>token</code> ä» Session ä¸­æ‹¿å‡ºï¼Œä¸è¯·æ±‚ä¸­çš„ <code>token</code> è¿›è¡Œæ¯”å¯¹ï¼Œä½†è¿™ç§æ–¹æ³•çš„æ¯”è¾ƒéº»çƒ¦çš„åœ¨äºå¦‚ä½•æŠŠ <code>token</code> ä»¥å‚æ•°çš„å½¢å¼åŠ å…¥è¯·æ±‚ã€‚</p>
<h3>åˆ†å¸ƒå¼æ ¡éªŒ</h3>
<p>åœ¨å¤§å‹ç½‘ç«™ä¸­ï¼Œä½¿ç”¨ Session å­˜å‚¨ CSRF Token ä¼šå¸¦æ¥å¾ˆå¤§çš„å‹åŠ›ã€‚è®¿é—®å•å°æœåŠ¡å™¨ session æ˜¯åŒä¸€ä¸ªã€‚ä½†æ˜¯ç°åœ¨çš„å¤§å‹ç½‘ç«™ä¸­ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨é€šå¸¸ä¸æ­¢ä¸€å°ï¼Œå¯èƒ½æ˜¯å‡ åå°ç”šè‡³å‡ ç™¾å°ä¹‹å¤šï¼Œç”šè‡³å¤šä¸ªæœºæˆ¿éƒ½å¯èƒ½åœ¨ä¸åŒçš„çœä»½ï¼Œç”¨æˆ·å‘èµ·çš„ HTTP è¯·æ±‚é€šå¸¸è¦ç»è¿‡åƒ Ngnix ä¹‹ç±»çš„è´Ÿè½½å‡è¡¡å™¨ä¹‹åï¼Œå†è·¯ç”±åˆ°å…·ä½“çš„æœåŠ¡å™¨ä¸Šï¼Œç”±äº Session é»˜è®¤å­˜å‚¨åœ¨å•æœºæœåŠ¡å™¨å†…å­˜ä¸­ï¼Œå› æ­¤åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åŒä¸€ä¸ªç”¨æˆ·å‘é€çš„å¤šæ¬¡ HTTP è¯·æ±‚å¯èƒ½ä¼šå…ˆåè½åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå¯¼è‡´åé¢å‘èµ·çš„ HTTP è¯·æ±‚æ— æ³•æ‹¿åˆ°ä¹‹å‰çš„ HTTP è¯·æ±‚å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸­çš„ Session æ•°æ®ï¼Œä»è€Œä½¿å¾— Session æœºåˆ¶åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆï¼Œå› æ­¤åœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸­ CSRF Token éœ€è¦å­˜å‚¨åœ¨ Redis ä¹‹ç±»çš„å…¬å…±å­˜å‚¨ç©ºé—´ã€‚</p>
<p>ç”±äºä½¿ç”¨ Session å­˜å‚¨ï¼Œè¯»å–å’ŒéªŒè¯ CSRF Token ä¼šå¼•èµ·æ¯”è¾ƒå¤§çš„å¤æ‚åº¦å’Œæ€§èƒ½é—®é¢˜ï¼Œç›®å‰å¾ˆå¤šç½‘ç«™é‡‡ç”¨ Encrypted Token Pattern æ–¹å¼ã€‚è¿™ç§æ–¹æ³•çš„ Token æ˜¯ä¸€ä¸ªè®¡ç®—å‡ºæ¥çš„ç»“æœï¼Œè€Œééšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ã€‚è¿™æ ·åœ¨æ ¡éªŒæ—¶æ— éœ€å†å»è¯»å–å­˜å‚¨çš„ Tokenï¼Œåªç”¨å†æ¬¡è®¡ç®—ä¸€æ¬¡å³å¯ã€‚</p>
<p>è¿™ç§ Token çš„å€¼é€šå¸¸æ˜¯ä½¿ç”¨ UserIDã€æ—¶é—´æˆ³å’Œéšæœºæ•°ï¼Œé€šè¿‡åŠ å¯†çš„æ–¹æ³•ç”Ÿæˆã€‚è¿™æ ·æ—¢å¯ä»¥ä¿è¯åˆ†å¸ƒå¼æœåŠ¡çš„ Token ä¸€è‡´ï¼Œåˆèƒ½ä¿è¯ Token ä¸å®¹æ˜“è¢«ç ´è§£ã€‚</p>
<p>åœ¨ Token è§£å¯†æˆåŠŸä¹‹åï¼ŒæœåŠ¡å™¨å¯ä»¥è®¿é—®è§£æå€¼ï¼ŒToken ä¸­åŒ…å«çš„ UserID å’Œæ—¶é—´æˆ³å°†ä¼šè¢«æ‹¿æ¥è¢«éªŒè¯æœ‰æ•ˆæ€§ï¼Œå°† UserID ä¸å½“å‰ç™»å½•çš„ UserID è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶å°†æ—¶é—´æˆ³ä¸å½“å‰æ—¶é—´è¿›è¡Œæ¯”è¾ƒã€‚</p>
<h3>åŒé‡ Cookie éªŒè¯</h3>
<p>æŒ‡åœ¨è¯·æ±‚å€Ÿå£æ—¶ï¼Œé™¤äº†å¸¸è§„å¸¦ä¸Š Cookie ä¸­çš„ç”¨æˆ·å‡­è¯ä¿¡æ¯ï¼Œå¦‚ <code>session_id</code> å¤–ï¼Œè¿˜æŠŠ Cookie ä¸­çš„ç”¨æˆ·å‡­è¯ä¿¡æ¯è¯»å‡ºæ¥é™„åœ¨æ¥å£è¯·æ±‚å‚æ•°é‡ï¼›è¿™ç§æ–¹æ¡ˆå¯¹æ¯” CSRF Token æ–¹æ¡ˆæ¥è¯´ï¼Œå¥½åœ¨ä¸éœ€è¦ç”Ÿæˆé¢å¤–å¾— Tokenï¼Œä¹ŸåŒæ ·èƒ½å¤Ÿèµ·åˆ°é˜²å¾¡ CSRF æ”»å‡»çš„æ•ˆæœã€‚</p>
<p>æµç¨‹ï¼š</p>
<ul>
<li>åœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™é¡µé¢æ—¶ï¼Œå‘è¯·æ±‚åŸŸåæ³¨å…¥ä¸€ä¸ª Cookieï¼Œå†…å®¹ä¸ºéšæœºå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ <code>csrfcookie=v8g9e4ksfhw</code>ï¼‰ï¼›</li>
<li>åœ¨å‰ç«¯å‘åç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œå–å‡º Cookieï¼Œå¹¶æ·»åŠ åˆ° URL çš„å‚æ•°ä¸­ï¼ˆæ¥ä¸Šä¾‹ POST https://www.a.com/comment?csrfcookie=v8g9e4ksfhwï¼‰ï¼›</li>
<li>åç«¯æ¥å£éªŒè¯ Cookie ä¸­çš„å­—æ®µä¸ URL å‚æ•°ä¸­çš„å­—æ®µæ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æ‹’ç»ã€‚</li>
</ul>
<p>æ­¤æ–¹æ³•ç›¸å¯¹äº CSRF Token å°±ç®€å•äº†è®¸å¤šã€‚å¯ä»¥ç›´æ¥é€šè¿‡å‰åç«¯æ‹¦æˆªçš„çš„æ–¹æ³•è‡ªåŠ¨åŒ–å®ç°ã€‚åç«¯æ ¡éªŒä¹Ÿæ›´åŠ æ–¹ä¾¿ï¼Œåªéœ€è¿›è¡Œè¯·æ±‚ä¸­å­—æ®µçš„å¯¹æ¯”ï¼Œè€Œä¸éœ€è¦å†è¿›è¡ŒæŸ¥è¯¢å’Œå­˜å‚¨ Tokenã€‚</p>
<p>å½“ç„¶ï¼Œæ­¤æ–¹æ³•å¹¶æ²¡æœ‰å¤§è§„æ¨¡åº”ç”¨ï¼Œå…¶åœ¨å¤§å‹ç½‘ç«™ä¸Šçš„å®‰å…¨æ€§è¿˜æ˜¯æ²¡æœ‰ CSRF Token é«˜ï¼ŒåŸå› æˆ‘ä»¬ä¸¾ä¾‹è¿›è¡Œè¯´æ˜ã€‚</p>
<p>ç”±äºä»»ä½•è·¨åŸŸéƒ½ä¼šå¯¼è‡´å‰ç«¯æ— æ³•è·å– Cookie ä¸­çš„å­—æ®µï¼ˆåŒ…æ‹¬å­åŸŸåä¹‹é—´ï¼‰ï¼Œäºæ˜¯å‘ç”Ÿäº†å¦‚ä¸‹æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœç”¨æˆ·è®¿é—®çš„ç½‘ç«™ä¸º <code>www.a.com</code>ï¼Œè€Œåç«¯çš„ API åŸŸåä¸º <code>api.a.com</code>ã€‚é‚£ä¹ˆåœ¨ <code>www.a.com</code> ä¸‹ï¼Œå‰ç«¯æ‹¿ä¸åˆ° <code>api.a.com</code> çš„ Cookieï¼Œä¹Ÿå°±æ— æ³•å®ŒæˆåŒé‡ Cookie è®¤è¯ã€‚</li>
<li>äºæ˜¯è¿™ä¸ªè®¤è¯ Cookie å¿…é¡»è¢«ç§åœ¨ <code>a.com</code> ä¸‹ï¼Œè¿™æ ·æ¯ä¸ªå­åŸŸéƒ½å¯ä»¥è®¿é—®ã€‚</li>
<li>ä»»ä½•ä¸€ä¸ªå­åŸŸéƒ½å¯ä»¥ä¿®æ”¹ <code>a.com</code> ä¸‹çš„ Cookieã€‚</li>
<li>æŸä¸ªå­åŸŸåå­˜åœ¨æ¼æ´è¢« XSS æ”»å‡»ï¼ˆä¾‹å¦‚ <code>upload.a.com</code>ï¼‰ã€‚è™½ç„¶è¿™ä¸ªå­åŸŸä¸‹å¹¶æ²¡æœ‰ä»€ä¹ˆå€¼å¾—çªƒå–çš„ä¿¡æ¯ã€‚ä½†æ”»å‡»è€…ä¿®æ”¹äº† <code>a.com</code> ä¸‹çš„ Cookieã€‚</li>
<li>æ”»å‡»è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è‡ªå·±é…ç½®çš„ Cookieï¼Œå¯¹ XSS ä¸­æ‹›çš„ç”¨æˆ·å†å‘ <code>www.a.com</code> ä¸‹ï¼Œå‘èµ· CSRF æ”»å‡»ã€‚</li>
</ul>
<h3>ç”¨æˆ·æ“ä½œé™åˆ¶</h3>
<p>CSRF æ”»å‡»è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·æ˜¯åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ„é€ äº†ç½‘ç»œè¯·æ±‚ï¼Œå› æ­¤æ·»åŠ éªŒè¯ç èƒ½å¼ºåˆ¶ç”¨æˆ·å¿…é¡»ä¸åº”ç”¨è¿›è¡Œäº¤äº’ï¼ŒæœåŠ¡å™¨é€šè¿‡éªŒè¯ç æ¥è¯†åˆ«æ˜¯ä¸æ˜¯ç”¨æˆ·ä¸»åŠ¨å‘é€çš„è¯·æ±‚ï¼Œç”±äºä¸€å®šå¼ºåº¦çš„éªŒè¯ç æœºå™¨æ— æ³•è¯†åˆ«ï¼Œå› æ­¤å±é™©ç½‘ç«™ä¸èƒ½ä¼ªé€ ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç®€æ´æœ‰æ•ˆï¼Œä½æˆæœ¬</li>
<li>ç¼ºç‚¹ï¼šå¯¹ç”¨æˆ·ä¸å‹å¥½ï¼Œæ— æ³•ç»™æ‰€æœ‰çš„æ“ä½œéƒ½åŠ ä¸ŠéªŒè¯ç </li>
</ul>
<h2>å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://juejin.im/post/5bc009996fb9a05d0a055192" target="_blank" rel="noopener noreferrer nofollow">ğŸ“ ç¾å›¢å‰ç«¯å®‰å…¨ç³»åˆ—ï¼šå¦‚ä½•é˜²æ­¢ CSRF æ”»å‡»?</a></li>
<li><a href="https://juejin.im/entry/58802eb58fd9c50067dd746b" target="_blank" rel="noopener noreferrer nofollow">ğŸ“ CSRF æ”»å‡»çš„åº”å¯¹ä¹‹é“</a></li>
<li><a href="https://juejin.im/entry/5b1e4575f265da6e2c19fd57" target="_blank" rel="noopener noreferrer nofollow">ğŸ“ CSRF æ¼æ´è¯¦ç»†è¯´æ˜</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener noreferrer nofollow">ğŸ“ JSON Web Token å…¥é—¨æ•™ç¨‹</a></li>
</ul>
4:["$","div",null,{"className":"markdown-body","children":["$","article",null,{"dangerouslySetInnerHTML":{"__html":"$c"}}]}]
a:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
8:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"front-end"}],["$","meta","2",{"name":"description","content":"front-end knowledge"}],["$","link","3",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}]]
6:null
