<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/569ce4b8f30dc480-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/ec0a9d078e716e00.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/485ff6fe79292a08.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/0ff121a467c0636f.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-038c2e688b596d0e.js"/><script src="/_next/static/chunks/4bd1b696-20882bf820444624.js" async=""></script><script src="/_next/static/chunks/517-98ed787e5f259f2c.js" async=""></script><script src="/_next/static/chunks/main-app-f33d3e3aed85e21f.js" async=""></script><meta name="next-size-adjust" content=""/><title>front-end</title><meta name="description" content="front-end knowledge"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__variable_4d318d __variable_ea5f4b antialiased"><main><div class="markdown-body"><h1>IndexedDB</h1><article><h1>IndexedDB</h1>
<p>indexedDB 的整体架构，是由一系列的单独概念串联而成，去不概念如下列表。</p>
<ul>
<li>IndexedDBRequest</li>
<li>IndexedDBFactory</li>
<li>IndexedDBDatabase</li>
<li>IndexedDBObjectStore</li>
<li>IndexedDBIndex</li>
<li>IndexedDBKeyRange</li>
<li>IndexedDBCursor</li>
<li>IndexedDBTransaction</li>
</ul>
<p>整体逻辑图如下：</p>
<pre class="hljs"><code class="language-jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> img <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../assets/indexeddb/overview.png&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-title function_">default</span> () =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;IndexedDB逻辑图&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{img}</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{540}</span> /&gt;</span></span>;
</code></pre>
<p>下文主要介绍了 indexedDB 的基本概念，以及在实际应用中的实操代码。</p>
<ul>
<li>indexedDB 基础概念。在 indexedDB 里面会根据索引 index 来进行整体数据结构的划分。</li>
<li>indexedDB 数据库的更新是一个非常蛋疼的事情，因为，Web 的灵活性，你既需要做好向上版本的更新，也需要完善向下版本的容错性。</li>
<li>indexedDB 高效索引机制，在内部，indexedDB 已经提供了 index、cursor 等高效的索引机制，推荐不要直接将所有数据都取回来，再进行筛选，而是直接利用 cursor 进行。</li>
<li>最后推荐几个常用库</li>
</ul>
<h2>离线存储</h2>
<p>IndexedDB 可以存储非常多类型的数据，比如 <code>Object</code>、<code>File</code>、<code>Blob</code> 等，里面的存储结构是根据 Database 来进行存储的。每个 DB 里面可以有不同的 Object Stores。具体结构如下图：</p>
<pre class="hljs"><code class="language-jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> img <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../assets/indexeddb/indexeddb-structure.png&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-title function_">default</span> () =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;IndexedDB结构图&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{img}</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{540}</span> /&gt;</span></span>;
</code></pre>
<p>并且，我们可以给 <code>key</code> 设定相关特定的值，然后在索引的时候，可以直接通过 <code>key</code> 得到具体的内容。使用 IndexDB 需要注意，其遵循的是 <strong>同域原则</strong>。</p>
<h2>基本概念</h2>
<p>在 indexDB 中，有几个基本的操作对象：</p>
<h3>Database</h3>
<p><code>Database</code> 通过 <code>open</code> 方法直接打开，可以得到一个实例的 DB。每个页面可以创建多个 DB，不过一般都是一个。</p>
<pre class="hljs"><code class="language-js">idb.<span class="hljs-title function_">open</span>(name, version, upgradeCallback);
</code></pre>
<h3>Object Store</h3>
<p><code>Object Store</code> 这个就是 DB 里面具体存储的对象。这个可以对应于 SQL 里面的 Table（表）内容。其存储的结构为：</p>
<pre class="hljs"><code class="language-jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> img <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../assets/indexeddb/object-store-example.png&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-title function_">default</span> () =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{img}</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{540}</span> /&gt;</span></span>;
</code></pre>
<h3>Index</h3>
<p><code>index</code> 有点类似于外链，它本身是一种 Object Store，主要是用来在本体的 Store 中，索引另外 Object Store 里面的数据。需要区别的是，<code>key</code> 和 <code>index</code> 是不一样的。</p>
<p>可以参考：<a href="https://mdn.github.io/indexeddb-examples/idbindex/" target="_blank" rel="noopener noreferrer nofollow">DEMO1</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBIndex" target="_blank" rel="noopener noreferrer nofollow">DEMO2</a></p>
<p>如下图表示：</p>
<pre class="hljs"><code class="language-jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> img <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../assets/indexeddb/indexeddb-index.png&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-title function_">default</span> () =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{img}</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{540}</span> /&gt;</span></span>;
</code></pre>
<pre class="hljs"><code class="language-js"><span class="hljs-comment">// 创建 index</span>
<span class="hljs-keyword">const</span> myIndex = objectStore.<span class="hljs-title function_">index</span>(<span class="hljs-string">&#x27;lName&#x27;</span>);
</code></pre>
<h3>Transaction</h3>
<p><code>transaction</code> 事务其实就是一系列 CRUD 的集合内容。如果其中一个环节失败了，那么整个事务的处理都会被取消。例如：</p>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">var</span> trans1 = db.<span class="hljs-title function_">transaction</span>(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;readwrite&#x27;</span>);
<span class="hljs-keyword">var</span> trans2 = db.<span class="hljs-title function_">transaction</span>(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;readwrite&#x27;</span>);
<span class="hljs-keyword">var</span> objectStore2 = trans2.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">&#x27;foo&#x27;</span>);
<span class="hljs-keyword">var</span> objectStore1 = trans1.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">&#x27;foo&#x27;</span>);
objectStore2.<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;key&#x27;</span>);
objectStore1.<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;key&#x27;</span>);
</code></pre>
<h3>Cursor</h3>
<p><code>cursor</code> 主要是用来遍历 DB 里面的数据内容。主要是通过 <code>openCursor</code> 来进行控制。</p>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">displayData</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">var</span> transaction = db.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">&#x27;rushAlbumList&#x27;</span>], <span class="hljs-string">&#x27;readonly&#x27;</span>);
  <span class="hljs-keyword">var</span> objectStore = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">&#x27;rushAlbumList&#x27;</span>);

  objectStore.<span class="hljs-title function_">openCursor</span>().<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">var</span> cursor = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
    <span class="hljs-keyword">if</span> (cursor) {
      <span class="hljs-keyword">var</span> listItem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;li&#x27;</span>);
      listItem.<span class="hljs-property">innerHTML</span> = cursor.<span class="hljs-property">value</span>.<span class="hljs-property">albumTitle</span> + <span class="hljs-string">&#x27;, &#x27;</span> + cursor.<span class="hljs-property">value</span>.<span class="hljs-property">year</span>;
      list.<span class="hljs-title function_">appendChild</span>(listItem);

      cursor.<span class="hljs-title function_">continue</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Entries all displayed.&#x27;</span>);
    }
  };
}
</code></pre>
<h2>基本用法</h2>
<h3>创建数据库</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">const</span> createUpdateStore = <span class="hljs-keyword">function</span> (<span class="hljs-params">name, version = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> request = <span class="hljs-variable language_">window</span>.<span class="hljs-property">indexdDB</span>.<span class="hljs-title function_">open</span>(name, version);

  request.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;open success&#x27;</span>);
  };

  request.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;open fail&#x27;</span>);
  };

  request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">const</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;

    <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(name)) {
      <span class="hljs-comment">// 创建仓库对象（创建表格）</span>
      <span class="hljs-comment">// 这里我将主键设为 ID</span>
      <span class="hljs-keyword">const</span> objectStore = db.<span class="hljs-title function_">createObjectStore</span>(name, {
        <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&#x27;id&#x27;</span>,
        <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>,
      });
    }
  };
};
</code></pre>
<h3>添加数据</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">const</span> addDataStore = <span class="hljs-keyword">function</span> (<span class="hljs-params">storeName, data, verson</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> databaseName = storeName;
    <span class="hljs-keyword">let</span> databaseVersion = verson || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> db;
    <span class="hljs-keyword">let</span> request = indexedDB.<span class="hljs-title function_">open</span>(databaseName, databaseVersion);

    request.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-comment">// 将数据保存到新建的对象仓库</span>
      <span class="hljs-keyword">let</span> objectStore = db.<span class="hljs-title function_">transaction</span>(databaseName, <span class="hljs-string">&#x27;readwrite&#x27;</span>).<span class="hljs-title function_">objectStore</span>(databaseName);
      <span class="hljs-keyword">if</span> (uf.<span class="hljs-property">utils</span>.<span class="hljs-title function_">typeof</span>(data, <span class="hljs-string">&#x27;array&#x27;</span>)) {
        data.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">dataItem</span>) {
          <span class="hljs-comment">// 添加一条数据</span>
          objectStore.<span class="hljs-title function_">add</span>(dataItem);
        });
        <span class="hljs-title function_">resolve</span>();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 添加一条数据</span>
        objectStore.<span class="hljs-title function_">add</span>(data);
        <span class="hljs-title function_">resolve</span>();
      }
    };

    request.<span class="hljs-property">error</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
      <span class="hljs-title function_">reject</span>();
    };

    request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">let</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(storeName)) {
        <span class="hljs-comment">// 创建仓库对象（创建表格）</span>
        <span class="hljs-comment">// 这里我将主键设置为id</span>
        <span class="hljs-keyword">let</span> objectStore = db.<span class="hljs-title function_">createObjectStore</span>(storeName, {
          <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&#x27;id&#x27;</span>,
          <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>,
        });
      }
    };
  });
};
</code></pre>
<h3>获取数据</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">let</span> getStoreData = <span class="hljs-keyword">function</span> (<span class="hljs-params">name, key = <span class="hljs-number">1</span></span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;getStoreData&#x27;</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> request = indexedDB.<span class="hljs-title function_">open</span>(name);
    request.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">let</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">let</span> req;
      <span class="hljs-keyword">try</span> {
        req = db.<span class="hljs-title function_">transaction</span>(name, <span class="hljs-string">&#x27;readwrite&#x27;</span>).<span class="hljs-title function_">objectStore</span>(name).<span class="hljs-title function_">get</span>(key); <span class="hljs-comment">// 这里的“1”也是主键的键值</span>
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;用户失败&#x27;</span>);
      }
      <span class="hljs-keyword">if</span> (!req) {
        <span class="hljs-keyword">return</span>;
      }
      req.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
        <span class="hljs-title function_">resolve</span>(req.<span class="hljs-property">result</span>);
      };
      req.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;获取失败&#x27;</span>);
      };
    };
    request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">let</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(name)) {
        <span class="hljs-comment">// 创建仓库对象（创建表格）</span>
        <span class="hljs-comment">// 这里我将主键设置为id</span>
        <span class="hljs-keyword">let</span> objectStore = db.<span class="hljs-title function_">createObjectStore</span>(name, {
          <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&#x27;id&#x27;</span>,
          <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>,
        });
      }
    };
  });
};
</code></pre>
<h3>删除数据</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">const</span> delectStoreData = <span class="hljs-keyword">function</span> (<span class="hljs-params">name, key</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;delectStoreData&#x27;</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> databaseName = name;
    <span class="hljs-keyword">let</span> db;
    <span class="hljs-keyword">let</span> request = <span class="hljs-variable language_">window</span>.<span class="hljs-property">indexedDB</span>.<span class="hljs-title function_">open</span>(databaseName);
    request.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-comment">// 这里指定的是主键的键值</span>
      <span class="hljs-keyword">let</span> req = db.<span class="hljs-title function_">transaction</span>(databaseName, <span class="hljs-string">&#x27;readwrite&#x27;</span>).<span class="hljs-title function_">objectStore</span>(databaseName).<span class="hljs-title function_">delete</span>(key);

      req.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;删除成功&#x27;</span>);
      };

      req.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;删除失败&#x27;</span>);
      };
    };
  });
};
</code></pre>
<h3>更新数据</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">const</span> updateStoreData = <span class="hljs-keyword">function</span> (<span class="hljs-params">storeName, newData, key</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;updateStoreData&#x27;</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> request = <span class="hljs-variable language_">window</span>.<span class="hljs-property">indexedDB</span>.<span class="hljs-title function_">open</span>(storeName);
    <span class="hljs-keyword">let</span> db;
    request.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">let</span> transaction = db.<span class="hljs-title function_">transaction</span>(storeName, <span class="hljs-string">&#x27;readwrite&#x27;</span>);
      <span class="hljs-keyword">let</span> store = transaction.<span class="hljs-title function_">objectStore</span>(storeName);
      <span class="hljs-keyword">let</span> storeData = store.<span class="hljs-title function_">get</span>(key);

      storeData.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">let</span> data = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span> || {};
        <span class="hljs-keyword">for</span> (a <span class="hljs-keyword">in</span> newData) {
          data[a] = newData[a];
        }
        store.<span class="hljs-title function_">put</span>(data);
        <span class="hljs-title function_">resolve</span>();
      };
    };
    request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">let</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(storeName)) {
        <span class="hljs-comment">// 创建仓库对象（创建表格）</span>
        <span class="hljs-comment">// 这里我将主键设置为id</span>
        <span class="hljs-keyword">let</span> objectStore = db.<span class="hljs-title function_">createObjectStore</span>(storeName, {
          <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&#x27;id&#x27;</span>,
          <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>,
        });
      }
    };
  });
};
</code></pre>
<h3>遍历获取</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">const</span> storeDataList = <span class="hljs-keyword">function</span> (<span class="hljs-params">storeName</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;storeDataList&#x27;</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> request = <span class="hljs-variable language_">window</span>.<span class="hljs-property">indexedDB</span>.<span class="hljs-title function_">open</span>(storeName);
    <span class="hljs-keyword">let</span> db;
    request.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">let</span> transaction = db.<span class="hljs-title function_">transaction</span>(storeName);
      <span class="hljs-keyword">let</span> store = transaction.<span class="hljs-title function_">objectStore</span>(storeName);
      <span class="hljs-comment">// 打开游标</span>
      <span class="hljs-keyword">let</span> cursor = store.<span class="hljs-title function_">openCursor</span>();
      <span class="hljs-keyword">let</span> dataList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();
      cursor.<span class="hljs-property">onsuccess</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">var</span> cursorVal = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
        <span class="hljs-keyword">if</span> (cursorVal) {
          dataList.<span class="hljs-title function_">push</span>(cursorVal.<span class="hljs-property">value</span>);
          cursorVal.<span class="hljs-title function_">continue</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 遍历结束</span>
          <span class="hljs-title function_">resolve</span>(dataList);
        }
      };
    };
    request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">let</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
      <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(storeName)) {
        <span class="hljs-comment">// 创建仓库对象（创建表格）</span>
        <span class="hljs-comment">// 这里我将主键设置为id</span>
        <span class="hljs-keyword">let</span> objectStore = db.<span class="hljs-title function_">createObjectStore</span>(storeName, {
          <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&#x27;id&#x27;</span>,
          <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>,
        });
      }
    };
  });
};
</code></pre>
<h3>批量删除</h3>
<pre class="hljs"><code class="language-js"><span class="hljs-keyword">const</span> batchDelete = <span class="hljs-keyword">function</span> (<span class="hljs-params">storeName, keys</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;batchDelete&#x27;</span>);
  <span class="hljs-keyword">let</span> allKeys = keys.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    item = +item;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">delectStoreData</span>(storeName, item);
  });
  <span class="hljs-keyword">return</span> allKeys;
  <span class="hljs-comment">/* Promise.all(allKeys).then(data =&gt; {
      console.log(data);
      resolve(data);
  });*/</span>
};
</code></pre>
<h2>第三方依赖库</h2>
<p>如果碰到前端频繁存储操作或者大文件缓存的需求，可以考虑使用 IndexedDB，当然项目中推荐直接使用第三方库：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://github.com/erikolson186/zangodb" target="_blank" rel="noopener noreferrer nofollow">zangodb</a></td>
<td style="text-align:left">ZangoDB 是一个类似 MongoDB 的 HTML5 IndexedDB 接口库，支持 MongoDB 的大多数常见功能包括 filer、sorting、updating 和 aggregation，可在 Web 浏览器中使用</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://dexie.org/" target="_blank" rel="noopener noreferrer nofollow">dexie.js</a></td>
<td style="text-align:left">IndexedDB 的简约包装器</td>
</tr>
</tbody>
</table>
<h2>参考资料</h2>
<ul>
<li><a href="https://juejin.cn/post/6844903608480169991" target="_blank" rel="noopener noreferrer nofollow">IndexedDB 打造靠谱 Web 离线数据库</a></li>
<li><a href="https://juejin.im/post/5c91b3c86fb9a070cf6bcab2" target="_blank" rel="noopener noreferrer nofollow">打造前端离线日志 IndexedDB</a></li>
</ul>
</article></div></main><script src="/_next/static/chunks/webpack-038c2e688b596d0e.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[5244,[],\"\"]\n3:I[3866,[],\"\"]\n5:I[6213,[],\"OutletBoundary\"]\n7:I[6213,[],\"MetadataBoundary\"]\n9:I[6213,[],\"ViewportBoundary\"]\nb:I[4835,[],\"\"]\n:HL[\"/_next/static/media/569ce4b8f30dc480-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/ec0a9d078e716e00.css\",\"style\"]\n:HL[\"/_next/static/css/485ff6fe79292a08.css\",\"style\"]\n:HL[\"/_next/static/css/0ff121a467c0636f.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"ToCgoFiTXvECVEVLCeZww\",\"p\":\"\",\"c\":[\"\",\"front-end\",\"browser-object-model\",\"offline-and-storage\",\"indexedDB\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"front-end\",{\"children\":[[\"slug\",\"browser-object-model/offline-and-storage/indexedDB\",\"oc\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/ec0a9d078e716e00.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_4d318d __variable_ea5f4b antialiased\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"front-end\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/485ff6fe79292a08.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0ff121a467c0636f.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"main\",null,{\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"front-end\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}],{\"children\":[[\"slug\",\"browser-object-model/offline-and-storage/indexedDB\",\"oc\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"front-end\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L4\",null,[\"$\",\"$L5\",null,{\"children\":\"$L6\"}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"omtk0j9JfBeMLnlhHA9wZ\",{\"children\":[[\"$\",\"$L7\",null,{\"children\":\"$L8\"}],[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$b\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:T72f8,"])</script><script>self.__next_f.push([1,"\u003ch1\u003eIndexedDB\u003c/h1\u003e\n\u003cp\u003eindexedDB 的整体架构，是由一系列的单独概念串联而成，去不概念如下列表。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIndexedDBRequest\u003c/li\u003e\n\u003cli\u003eIndexedDBFactory\u003c/li\u003e\n\u003cli\u003eIndexedDBDatabase\u003c/li\u003e\n\u003cli\u003eIndexedDBObjectStore\u003c/li\u003e\n\u003cli\u003eIndexedDBIndex\u003c/li\u003e\n\u003cli\u003eIndexedDBKeyRange\u003c/li\u003e\n\u003cli\u003eIndexedDBCursor\u003c/li\u003e\n\u003cli\u003eIndexedDBTransaction\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e整体逻辑图如下：\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e img \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;../../assets/indexeddb/overview.png\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edefault\u003c/span\u003e () =\u0026gt; \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eimg\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ealt\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;IndexedDB逻辑图\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003esrc\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{img}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ewidth\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{540}\u003c/span\u003e /\u0026gt;\u003c/span\u003e\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e下文主要介绍了 indexedDB 的基本概念，以及在实际应用中的实操代码。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eindexedDB 基础概念。在 indexedDB 里面会根据索引 index 来进行整体数据结构的划分。\u003c/li\u003e\n\u003cli\u003eindexedDB 数据库的更新是一个非常蛋疼的事情，因为，Web 的灵活性，你既需要做好向上版本的更新，也需要完善向下版本的容错性。\u003c/li\u003e\n\u003cli\u003eindexedDB 高效索引机制，在内部，indexedDB 已经提供了 index、cursor 等高效的索引机制，推荐不要直接将所有数据都取回来，再进行筛选，而是直接利用 cursor 进行。\u003c/li\u003e\n\u003cli\u003e最后推荐几个常用库\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e离线存储\u003c/h2\u003e\n\u003cp\u003eIndexedDB 可以存储非常多类型的数据，比如 \u003ccode\u003eObject\u003c/code\u003e、\u003ccode\u003eFile\u003c/code\u003e、\u003ccode\u003eBlob\u003c/code\u003e 等，里面的存储结构是根据 Database 来进行存储的。每个 DB 里面可以有不同的 Object Stores。具体结构如下图：\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e img \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;../../assets/indexeddb/indexeddb-structure.png\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edefault\u003c/span\u003e () =\u0026gt; \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eimg\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ealt\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;IndexedDB结构图\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003esrc\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{img}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ewidth\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{540}\u003c/span\u003e /\u0026gt;\u003c/span\u003e\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e并且，我们可以给 \u003ccode\u003ekey\u003c/code\u003e 设定相关特定的值，然后在索引的时候，可以直接通过 \u003ccode\u003ekey\u003c/code\u003e 得到具体的内容。使用 IndexDB 需要注意，其遵循的是 \u003cstrong\u003e同域原则\u003c/strong\u003e。\u003c/p\u003e\n\u003ch2\u003e基本概念\u003c/h2\u003e\n\u003cp\u003e在 indexDB 中，有几个基本的操作对象：\u003c/p\u003e\n\u003ch3\u003eDatabase\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eDatabase\u003c/code\u003e 通过 \u003ccode\u003eopen\u003c/code\u003e 方法直接打开，可以得到一个实例的 DB。每个页面可以创建多个 DB，不过一般都是一个。\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003eidb.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(name, version, upgradeCallback);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eObject Store\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eObject Store\u003c/code\u003e 这个就是 DB 里面具体存储的对象。这个可以对应于 SQL 里面的 Table（表）内容。其存储的结构为：\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e img \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;../../assets/indexeddb/object-store-example.png\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edefault\u003c/span\u003e () =\u0026gt; \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eimg\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ealt\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003esrc\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{img}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ewidth\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{540}\u003c/span\u003e /\u0026gt;\u003c/span\u003e\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eIndex\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eindex\u003c/code\u003e 有点类似于外链，它本身是一种 Object Store，主要是用来在本体的 Store 中，索引另外 Object Store 里面的数据。需要区别的是，\u003ccode\u003ekey\u003c/code\u003e 和 \u003ccode\u003eindex\u003c/code\u003e 是不一样的。\u003c/p\u003e\n\u003cp\u003e可以参考：\u003ca href=\"https://mdn.github.io/indexeddb-examples/idbindex/\" target=\"_blank\" rel=\"noopener noreferrer nofollow\"\u003eDEMO1\u003c/a\u003e、\u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/IDBIndex\" target=\"_blank\" rel=\"noopener noreferrer nofollow\"\u003eDEMO2\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e如下图表示：\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e img \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;../../assets/indexeddb/indexeddb-index.png\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edefault\u003c/span\u003e () =\u0026gt; \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eimg\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ealt\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003esrc\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{img}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ewidth\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{540}\u003c/span\u003e /\u0026gt;\u003c/span\u003e\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 创建 index\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e myIndex = objectStore.\u003cspan class=\"hljs-title function_\"\u003eindex\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;lName\u0026#x27;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eTransaction\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003etransaction\u003c/code\u003e 事务其实就是一系列 CRUD 的集合内容。如果其中一个环节失败了，那么整个事务的处理都会被取消。例如：\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e trans1 = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;foo\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readwrite\u0026#x27;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e trans2 = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;foo\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readwrite\u0026#x27;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e objectStore2 = trans2.\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;foo\u0026#x27;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e objectStore1 = trans1.\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;foo\u0026#x27;\u003c/span\u003e);\nobjectStore2.\u003cspan class=\"hljs-title function_\"\u003eput\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;2\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;key\u0026#x27;\u003c/span\u003e);\nobjectStore1.\u003cspan class=\"hljs-title function_\"\u003eput\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;1\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;key\u0026#x27;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eCursor\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003ecursor\u003c/code\u003e 主要是用来遍历 DB 里面的数据内容。主要是通过 \u003ccode\u003eopenCursor\u003c/code\u003e 来进行控制。\u003c/p\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edisplayData\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e transaction = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e([\u003cspan class=\"hljs-string\"\u003e\u0026#x27;rushAlbumList\u0026#x27;\u003c/span\u003e], \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readonly\u0026#x27;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e objectStore = transaction.\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;rushAlbumList\u0026#x27;\u003c/span\u003e);\n\n  objectStore.\u003cspan class=\"hljs-title function_\"\u003eopenCursor\u003c/span\u003e().\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e cursor = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (cursor) {\n      \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e listItem = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;li\u0026#x27;\u003c/span\u003e);\n      listItem.\u003cspan class=\"hljs-property\"\u003einnerHTML\u003c/span\u003e = cursor.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ealbumTitle\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026#x27;, \u0026#x27;\u003c/span\u003e + cursor.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eyear\u003c/span\u003e;\n      list.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(listItem);\n\n      cursor.\u003cspan class=\"hljs-title function_\"\u003econtinue\u003c/span\u003e();\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;Entries all displayed.\u0026#x27;\u003c/span\u003e);\n    }\n  };\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e基本用法\u003c/h2\u003e\n\u003ch3\u003e创建数据库\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e createUpdateStore = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ename, version = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e request = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eindexdDB\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(name, version);\n\n  request.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;open success\u0026#x27;\u003c/span\u003e);\n  };\n\n  request.\u003cspan class=\"hljs-property\"\u003eonerror\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;open fail\u0026#x27;\u003c/span\u003e);\n  };\n\n  request.\u003cspan class=\"hljs-property\"\u003eonupgradeneeded\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!db.\u003cspan class=\"hljs-property\"\u003eobjectStoreNames\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003econtains\u003c/span\u003e(name)) {\n      \u003cspan class=\"hljs-comment\"\u003e// 创建仓库对象（创建表格）\u003c/span\u003e\n      \u003cspan class=\"hljs-comment\"\u003e// 这里我将主键设为 ID\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e objectStore = db.\u003cspan class=\"hljs-title function_\"\u003ecreateObjectStore\u003c/span\u003e(name, {\n        \u003cspan class=\"hljs-attr\"\u003ekeyPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;id\u0026#x27;\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003eautoIncrement\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n      });\n    }\n  };\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e添加数据\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e addDataStore = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003estoreName, data, verson\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e databaseName = storeName;\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e databaseVersion = verson || \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db;\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e request = indexedDB.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(databaseName, databaseVersion);\n\n    request.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-comment\"\u003e// 将数据保存到新建的对象仓库\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e objectStore = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(databaseName, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readwrite\u0026#x27;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(databaseName);\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (uf.\u003cspan class=\"hljs-property\"\u003eutils\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003etypeof\u003c/span\u003e(data, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;array\u0026#x27;\u003c/span\u003e)) {\n        data.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003edataItem\u003c/span\u003e) {\n          \u003cspan class=\"hljs-comment\"\u003e// 添加一条数据\u003c/span\u003e\n          objectStore.\u003cspan class=\"hljs-title function_\"\u003eadd\u003c/span\u003e(dataItem);\n        });\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e();\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment\"\u003e// 添加一条数据\u003c/span\u003e\n        objectStore.\u003cspan class=\"hljs-title function_\"\u003eadd\u003c/span\u003e(data);\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e();\n      }\n    };\n\n    request.\u003cspan class=\"hljs-property\"\u003eerror\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n      \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e();\n    };\n\n    request.\u003cspan class=\"hljs-property\"\u003eonupgradeneeded\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!db.\u003cspan class=\"hljs-property\"\u003eobjectStoreNames\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003econtains\u003c/span\u003e(storeName)) {\n        \u003cspan class=\"hljs-comment\"\u003e// 创建仓库对象（创建表格）\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// 这里我将主键设置为id\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e objectStore = db.\u003cspan class=\"hljs-title function_\"\u003ecreateObjectStore\u003c/span\u003e(storeName, {\n          \u003cspan class=\"hljs-attr\"\u003ekeyPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;id\u0026#x27;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003eautoIncrement\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n        });\n      }\n    };\n  });\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e获取数据\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e getStoreData = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ename, key = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;getStoreData\u0026#x27;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e request = indexedDB.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(name);\n    request.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e req;\n      \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n        req = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(name, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readwrite\u0026#x27;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(name).\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(key); \u003cspan class=\"hljs-comment\"\u003e// 这里的“1”也是主键的键值\u003c/span\u003e\n      } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (e) {\n        \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;用户失败\u0026#x27;\u003c/span\u003e);\n      }\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!req) {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n      }\n      req.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(req.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e);\n      };\n      req.\u003cspan class=\"hljs-property\"\u003eonerror\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;获取失败\u0026#x27;\u003c/span\u003e);\n      };\n    };\n    request.\u003cspan class=\"hljs-property\"\u003eonupgradeneeded\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!db.\u003cspan class=\"hljs-property\"\u003eobjectStoreNames\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003econtains\u003c/span\u003e(name)) {\n        \u003cspan class=\"hljs-comment\"\u003e// 创建仓库对象（创建表格）\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// 这里我将主键设置为id\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e objectStore = db.\u003cspan class=\"hljs-title function_\"\u003ecreateObjectStore\u003c/span\u003e(name, {\n          \u003cspan class=\"hljs-attr\"\u003ekeyPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;id\u0026#x27;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003eautoIncrement\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n        });\n      }\n    };\n  });\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e删除数据\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e delectStoreData = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ename, key\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;delectStoreData\u0026#x27;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e databaseName = name;\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db;\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e request = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eindexedDB\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(databaseName);\n    request.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-comment\"\u003e// 这里指定的是主键的键值\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e req = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(databaseName, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readwrite\u0026#x27;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(databaseName).\u003cspan class=\"hljs-title function_\"\u003edelete\u003c/span\u003e(key);\n\n      req.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;删除成功\u0026#x27;\u003c/span\u003e);\n      };\n\n      req.\u003cspan class=\"hljs-property\"\u003eonerror\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;删除失败\u0026#x27;\u003c/span\u003e);\n      };\n    };\n  });\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e更新数据\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e updateStoreData = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003estoreName, newData, key\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;updateStoreData\u0026#x27;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e request = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eindexedDB\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(storeName);\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db;\n    request.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e transaction = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(storeName, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;readwrite\u0026#x27;\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e store = transaction.\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(storeName);\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e storeData = store.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(key);\n\n      storeData.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e data = e.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e || {};\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (a \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e newData) {\n          data[a] = newData[a];\n        }\n        store.\u003cspan class=\"hljs-title function_\"\u003eput\u003c/span\u003e(data);\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e();\n      };\n    };\n    request.\u003cspan class=\"hljs-property\"\u003eonupgradeneeded\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!db.\u003cspan class=\"hljs-property\"\u003eobjectStoreNames\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003econtains\u003c/span\u003e(storeName)) {\n        \u003cspan class=\"hljs-comment\"\u003e// 创建仓库对象（创建表格）\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// 这里我将主键设置为id\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e objectStore = db.\u003cspan class=\"hljs-title function_\"\u003ecreateObjectStore\u003c/span\u003e(storeName, {\n          \u003cspan class=\"hljs-attr\"\u003ekeyPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;id\u0026#x27;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003eautoIncrement\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n        });\n      }\n    };\n  });\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e遍历获取\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e storeDataList = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003estoreName\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;storeDataList\u0026#x27;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e request = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eindexedDB\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(storeName);\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db;\n    request.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e transaction = db.\u003cspan class=\"hljs-title function_\"\u003etransaction\u003c/span\u003e(storeName);\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e store = transaction.\u003cspan class=\"hljs-title function_\"\u003eobjectStore\u003c/span\u003e(storeName);\n      \u003cspan class=\"hljs-comment\"\u003e// 打开游标\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e cursor = store.\u003cspan class=\"hljs-title function_\"\u003eopenCursor\u003c/span\u003e();\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e dataList = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArray\u003c/span\u003e();\n      cursor.\u003cspan class=\"hljs-property\"\u003eonsuccess\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e cursorVal = e.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (cursorVal) {\n          dataList.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(cursorVal.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e);\n          cursorVal.\u003cspan class=\"hljs-title function_\"\u003econtinue\u003c/span\u003e();\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n          \u003cspan class=\"hljs-comment\"\u003e// 遍历结束\u003c/span\u003e\n          \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(dataList);\n        }\n      };\n    };\n    request.\u003cspan class=\"hljs-property\"\u003eonupgradeneeded\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e db = event.\u003cspan class=\"hljs-property\"\u003etarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!db.\u003cspan class=\"hljs-property\"\u003eobjectStoreNames\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003econtains\u003c/span\u003e(storeName)) {\n        \u003cspan class=\"hljs-comment\"\u003e// 创建仓库对象（创建表格）\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// 这里我将主键设置为id\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e objectStore = db.\u003cspan class=\"hljs-title function_\"\u003ecreateObjectStore\u003c/span\u003e(storeName, {\n          \u003cspan class=\"hljs-attr\"\u003ekeyPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;id\u0026#x27;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003eautoIncrement\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n        });\n      }\n    };\n  });\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e批量删除\u003c/h3\u003e\n\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e batchDelete = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003estoreName, keys\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;batchDelete\u0026#x27;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e allKeys = keys.\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eitem\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    item = +item;\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edelectStoreData\u003c/span\u003e(storeName, item);\n  });\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e allKeys;\n  \u003cspan class=\"hljs-comment\"\u003e/* Promise.all(allKeys).then(data =\u0026gt; {\n      console.log(data);\n      resolve(data);\n  });*/\u003c/span\u003e\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e第三方依赖库\u003c/h2\u003e\n\u003cp\u003e如果碰到前端频繁存储操作或者大文件缓存的需求，可以考虑使用 IndexedDB，当然项目中推荐直接使用第三方库：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left\"\u003e名称\u003c/th\u003e\n\u003cth style=\"text-align:left\"\u003e说明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ca href=\"https://github.com/erikolson186/zangodb\" target=\"_blank\" rel=\"noopener noreferrer nofollow\"\u003ezangodb\u003c/a\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eZangoDB 是一个类似 MongoDB 的 HTML5 IndexedDB 接口库，支持 MongoDB 的大多数常见功能包括 filer、sorting、updating 和 aggregation，可在 Web 浏览器中使用\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ca href=\"https://dexie.org/\" target=\"_blank\" rel=\"noopener noreferrer nofollow\"\u003edexie.js\u003c/a\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eIndexedDB 的简约包装器\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch2\u003e参考资料\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844903608480169991\" target=\"_blank\" rel=\"noopener noreferrer nofollow\"\u003eIndexedDB 打造靠谱 Web 离线数据库\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.im/post/5c91b3c86fb9a070cf6bcab2\" target=\"_blank\" rel=\"noopener noreferrer nofollow\"\u003e打造前端离线日志 IndexedDB\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"])</script><script>self.__next_f.push([1,"4:[\"$\",\"div\",null,{\"className\":\"markdown-body\",\"children\":[[\"$\",\"h1\",null,{\"children\":\"IndexedDB\"}],[\"$\",\"article\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$c\"}}]]}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n8:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"front-end\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"front-end knowledge\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n"])</script><script>self.__next_f.push([1,"6:null\n"])</script></body></html>